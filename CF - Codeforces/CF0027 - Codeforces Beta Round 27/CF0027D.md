---
contest: "[[CF-0027]]"
tags:
  - Mercor
  - Grafos
  - Geometría
---
# D - Ring Road 2

> [!success] [[CF-0027-D.cpp]]
> Pensarlo como grafo planar, hago 2-SAT para elegir quien va adentro/afuera.
> Puedo zafar de codear 2-SAT porque cada componente es fuertemente conexa, solo hace falta un DSU, añado una arista cuando dos cuerdas se intersecan.

## Scratchpad
### Initial Thoughts

- We can model this problem as a graph, where cities are nodes, and we add an edge between pairs of cities connected by a road.
- This particular problem seems related with the idea of planar graphs, as we want edges to only intersect at vertices.
- We want to check if the resulting graph is planar and, additionally, give a way to build the roads for them to not intersect (that is, an embedding of the graph in the plane).
- As shown in the statement, we have two ways to embed the additional roads: either inside or outside the ring.
- We can think of assigning a binary variable to each of these roads, stating whether or not they are inside the ring. 
- Perhaps we can model the problem as a 2-Satisfiability problem, and solve it quickly to both check feasibility and get a valid embedding in one step.

### Step-by-Step Solution

- As we want to model the problem with 2-SAT clauses, we should think about what restrictions with two binary variables we can give to a graph.
- We want to model "edge intersections", it's clear that if one edge is inside the ring, while the other is outside the ring, that this edges cannot intersect.
- The problems can arise when either both edges are outside or inside the ring, we can think about them being both inside the ring, as if they intersect inside, they intersect outside and viceversa.
- We can now think about these edges as chords inside of a regular polygon with $n$ sides, we want to know whether or not the two chords intersect.
- If the edges are $a_1, b_1$ and $a_2, b_2$, with $a_1 < b_1, a_2 < b_2$, the chords intersect if and only if exactly one of $a_2$ and $b_2$ is inside of the interval $[a_1, b_1]$.
- If the chords do intersect, then one of them must be outside the polygon, and the other one must be inside the polygon.
- If the variables are $x_i$ and $x_j$, we can model this using 2-SAT clauses as $(x_i \lor x_j) \land (\lnot x_i \lor \lnot x_j)$, that is, exactly one of $x_i$ and $x_j$ must be true.
- Conversely, if we find an assignment which satisfies every clause, we must have an answer to the problem, as no pair of roads intersects, and therefore we will have an embedding of the graph (which means it must be planar).
- The type of clause we have means we can avoid implementing 2-SAT: right now, a clause says "$x_i$ is true if and only if $x_j$ is false".
- This means that we will add the edges $x_i \to \lnot x_j, \lnot x_i \to x_j, \lnot x_j \to x_i, x_j \to \lnot x_i$, so for each edge we will have its reverse as well.
- This simplifies the implementation, as every connected component will be strongly connected, we can simply use a Disjoint-Set Union instead of computing Strongly-Connected Components.
- For this, we create a graph with $2m$ nodes, $x_i$ and $\lnot x_i$ for each road we want to create, and add edges $x_i, \lnot x_j$ and $\lnot x_i, x_j$ if chords $i$ and $j$ intersect.
- There is a valid assignment if and only if $x_i$ lies in a different component from $\lnot x_i$, and in this case we can choose to assign it the component with smallest number.
- Note: there is a small problem in how we compute whether or not two chords intersect, we should first make sure that all four endpoints are different, otherwise they will intersect at a vertex (which *is* allowed).

## Final Solution

- Create a DSU with $2m$ vertices, $I_1, \dots, I_m$ and $O_1, \dots, O_m$, which represent the choice of road $i$ being Inside or Outside the ring.
- Iterate over each pair of roads $(a_i, b_i), (a_j, b_j)$, where we assume $a_i < b_i, a_j < b_j$.
- If $\#\set{a_i, b_i, a_j, b_j} = 4$, and exactly one of $a_i$ and $b_i$ lies inside of the interval $[a_i, b_i]$, we join vertices $I_i$ with $O_j$ and $O_i$ with $I_j$ in the DSU.
- If there is some $i$ such that $I_i$ and $O_i$ lie in the same component, there is no solution.
- Otherwise, assign to each road $i$ to the inside if the component number of $I_i$ is smaller than that of $O_i$, otherwise assign it to the outside.